Note: we have a setup script that automates most of this. This is a more detailed guide to understand what it does.

# Prerequisites for demo scripts
We'll start by setting up an automated demo environment, that allows to this this project in a pre re-producible way.

Go go through the demo steps detailed below, you will need:
- node (tested with nodejs 10)
- npm
- yarn (deploy LinkToken)
- kind (kuberentes in docker)
- kubectl
- make
- docker
- jq
- curl
- geth (used for scripting)

You will also need twitter API keys (you can open a twitter developer account to get these. the free
one works fine).

## Optional: 
For adapter development, you will need `go`.
To re-generate the db yaml, you will need `helm`. use the following command:

```bash
helm template release bitnami/postgresql > manifests/postgresql.yaml
```
## Bootstrap

First, install dependencies with:
```bash
git submodule update --init --recursive
npm install
```

We'll start by creating a local setup in kubernetes. To keep things simple, we will use KinD to
setup everything on our laptop. Kubernetes is used so we can replicate the setup fast in a
reproducible fashion. This can also potentially run in CI systems.

# Demo Environment Setup

## Deploy a local test network

In this step, we will deploy the a local block chain with ganache, and deploy the Link coin to it.
We use ganache in deterministic mode, so ADDRESS and KEY should be the same every time. you can see them in the ganache log output.

```bash
make deploy-testnet
kubectl rollout status deploy/ganache
# may need to sleep here to see logs
# the created addresses will be in the log:
#    kubectl logs deploy/ganache
# may need to re-try / sleep here until ganache initializes
make deploy-token
```

in the output of `make deploy-token` you will see:
```
  LinkToken: 0x5b1869d9a4c187f2eaa108f3062412ecf0526b24
```
If the output is different, update the variable in the next step.

## Deploy chainlink node

```bash
# ganache generates 10 address for testing. This is first address generated by ganache. 
# You can see it in the ganache logs. If your output does not contain this address, adjust this 
# variable accordingly.
export ADDRESS=0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1
# Link token address from the above link token deployment.
export LINK_TOKEN=0x5b1869d9a4c187f2eaa108f3062412ecf0526b24

# Deploy the chainlink node into kind.
make deploy-node

# Wait for node to become ready (it may crash a couple of times while the db initializes):
kubectl rollout status deploy/chainlink

export NODE_ADDR=$(kubectl logs deploy/chainlink|grep "please deposit ETH into your address:"| tr ' ' '\n'|grep 0x)
```

## Fund the node with ETH and LINK
In reality you want to be precise here. But since it's a test network, we'll just transfer a good
amount that's enough for our tests.
```bash
# Add 10 eth to the node
geth attach http://localhost:32000 -exec 'eth.sendTransaction({from: "'${ADDRESS}'",to: "'${NODE_ADDR}'", value: "10000000000000000000"})'

# Add link to the node
geth attach http://localhost:32000 --jspath ./scripts -exec 'loadScript("fund.js");transfer("'$LINK_TOKEN'", "'$ADDRESS'", "'$NODE_ADDR'");'

# Optional - verify node balance:
geth attach http://localhost:32000 --jspath ./scripts -exec 'loadScript("fund.js");getbalance("'$LINK_TOKEN'", "'$ADDRESS'", "'$NODE_ADDR'");'
```

## Deploy oracle
Now we deploy the chainlink oracle contract.

```bash
# this will also add the node to the oracle (by using the address in the env-var )
npm run deploy-oracle | tee node-tmp.txt
export ORACLE_ADDR=$(grep "contract-address" node-tmp.txt | cut -f 2)
rm node-tmp.txt
```

# Optional - Verify environment - Run the chainlink test consumer
To verify that our environment is working, we can use the chainlink test consumer. You can also skip
this step.

## Add jobs to the node

port forward to the node's ui/api port:
```bash
kubectl port-forward deploy/chainlink 6688&
```

Log-in in to the node:
```bash
curl -c cookiefile \
  -d '{"email":"foo@example.com", "password":"apipassword"}' \
  -X POST -H 'Content-Type: application/json' \
   http://localhost:6688/sessions
```

Create jobs:
```bash
# optional: verify that the node sees its balances:
# curl -c cookiefile http://localhost:6688/v2/user/balances

# create the jobs:
curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d '{"initiators":[{"type":"runlog","params":{"address":"'$ORACLE_ADDR'"}}],"tasks":[{"type":"httpget"},{"type":"jsonparse"},{"type":"ethbytes32"},{"type":"ethtx"}]}'

curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d '{"initiators":[{"type":"runlog","params":{"address":"'$ORACLE_ADDR'"}}],"tasks":[{"type":"httppost"},{"type":"jsonparse"},{"type":"ethbytes32"},{"type":"ethtx"}]}'

curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d '{"initiators":[{"type":"runlog","params":{"address":"'$ORACLE_ADDR'"}}],"tasks":[{"type":"httpget"},{"type":"jsonparse"},{"type":"multiply"},{"type":"ethint256"},{"type":"ethtx"}]}'

# save job id of EthUint256 as we need it for later
JOB_ID=$(curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d '{"initiators":[{"type":"runlog","params":{"address":"'$ORACLE_ADDR'"}}],"tasks":[{"type":"httpget"},{"type":"jsonparse"},{"type":"multiply"},{"type":"ethuint256"},{"type":"ethtx"}]}' | jq .data.id -r)

curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d '{"initiators":[{"type":"runlog","params":{"address":"'$ORACLE_ADDR'"}}],"tasks":[{"type":"httpget"},{"type":"jsonparse"},{"type":"ethbool"},{"type":"ethtx"}]}'
```

## Create test with the test consumer

```bash
npm run deploy-testconsumer | tee node-tmp.txt
export TEST_CONTRACT_ADDR=$(grep "contract-address" node-tmp.txt | cut -f 2)
rm node-tmp.txt
# fund the consumer contract:
geth attach http://localhost:32000 --jspath ./scripts -exec 'loadScript("fund.js");transfer("'$LINK_TOKEN'", "'$ADDRESS'", "'$TEST_CONTRACT_ADDR'");'
# verify funds contract:
geth attach http://localhost:32000 --jspath ./scripts -exec 'loadScript("fund.js");getbalance("'$LINK_TOKEN'", "'$TEST_CONTRACT_ADDR'");'

# make a request from the contract
node scripts/testcontract.js $TEST_CONTRACT_ADDR $ORACLE_ADDR $JOB_ID
```

You should see a job executed in the node UI! success!!


## Debugging
if we see failure, we can get transaction id and debug with truffle:
```bash
kubectl logs deploy/ganache
# get transaction id; go to the truffle directory containing the contract, and:
../../node_modules/.bin/truffle debug --network ganache <transaction id>
```

# Deploy twitter adapter

If we skipped the previous step, port forward to the node's ui/api port:
```bash
kubectl port-forward deploy/chainlink 6688&
# give kubectl a second to start working
sleep 1
```

Log-in in to the node (do this again, in case the cookie expired):
```bash
curl -c cookiefile \
  -d '{"email":"foo@example.com", "password":"apipassword"}' \
  -X POST -H 'Content-Type: application/json' \
   http://localhost:6688/sessions
```

Registe/r the twitter adapter with the node, so we have it's api keys:

```bash
curl -b cookiefile http://localhost:6688/v2/bridge_types -XPOST -H"content-type: application/json" -d @adapter/bridge.json > bridge_create.json
export INCOMING_TOKEN=$(jq '.data.attributes.incomingToken' bridge_create.json -r)
export OUTGOING_TOKEN=$(jq '.data.attributes.outgoingToken' bridge_create.json -r)
rm bridge_create.json
```

Note: If you made a mistake creating the bridge, you can delete it like so: `curl -v -b cookiefile -X DELETE http://localhost:6688/v2/bridge_types/twitter` (mistakes happen)...

Have your twitter secrets setup as environment variables:
- TWITTER_API_KEY
- TWITTER_API_KEY_SECRET
- TWITTER_ACCESS_TOKEN
- TWITTER_ACCESS_TOKEN_SECRET

Now we can deploy the adapter:
```bash
# create a kubernetes secret with all our keys
kubectl create secret generic twitter-adapter \
    --from-literal=TWITTER_API_KEY=$TWITTER_API_KEY \
    --from-literal=TWITTER_API_KEY_SECRET=$TWITTER_API_KEY_SECRET \
    --from-literal=TWITTER_ACCESS_TOKEN=$TWITTER_ACCESS_TOKEN \
    --from-literal=TWITTER_ACCESS_TOKEN_SECRET=$TWITTER_ACCESS_TOKEN_SECRET \
    --from-literal=INCOMING_TOKEN=$INCOMING_TOKEN \
    --from-literal=OUTGOING_TOKEN=$OUTGOING_TOKEN
# deploy the external adapter
make deploy-adapter
```

Add the twitter job spec to the node:

```bash
# add the current oracle address to the job spec
sed -e "s/ORACLE_ADDR/$ORACLE_ADDR/" adapter/jobspec.json > jobspec.json
# add the job to the node, and save the job id.
export TWITTER_JOB_ID=$(curl -b cookiefile http://localhost:6688/v2/specs -XPOST -H"content-type: application/json" -d @jobspec.json | jq .data.id -r)
rm jobspec.json
```

That's it! we are all setup!